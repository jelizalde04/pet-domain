name: Docker Build and Deploy Pet Domain

on:
  push:
    branches:
      - test

jobs:
  # Build y Push create-pet
  build_and_push_create_pet:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Export environment variables for test
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "PET_DB_NAME=${{ secrets.PET_DB_NAME }}" >> $GITHUB_ENV
          echo "RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}" >> $GITHUB_ENV

      - name: Install dependencies and run tests for create-pet
        run: |
          cd create-pet
          npm install
          npm test

      - name: Build and push Docker image for create-pet
        run: |
          docker build -t joeli2104/create-pet:latest ./create-pet
          docker push joeli2104/create-pet:latest

  deploy_ec2_create_pet:
    runs-on: ubuntu-latest
    needs: build_and_push_create_pet
    steps:
      - name: Deploy create-pet to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_PET_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            export AWS_REGION=${{ secrets.AWS_REGION }}
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            export RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}
            export S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            export DB_PORT=${{ secrets.DB_PORT }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            export DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}

            docker stop create-pet || true
            docker rm create-pet || true

            docker run -d --name create-pet \
              -p 3001:3001 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
              -e AWS_REGION=${{ secrets.AWS_REGION }} \
              -e PET_DB_NAME=${{ secrets.PET_DB_NAME }} \
              -e RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} \
              -e DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }} \
              joeli2104/create-pet:latest

  # Build y Push update-pet
  build_and_push_update_pet:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Export environment variables for test
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "PET_DB_NAME=${{ secrets.PET_DB_NAME }}" >> $GITHUB_ENV
          echo "RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}" >> $GITHUB_ENV

      - name: Install dependencies and run tests for update-pet
        run: |
          cd update-pet
          npm install
          npm test

      - name: Build and push Docker image for update-pet
        run: |
          docker build -t joeli2104/update-pet:latest ./update-pet
          docker push joeli2104/update-pet:latest

  deploy_ec2_update_pet:
    runs-on: ubuntu-latest
    needs: build_and_push_update_pet
    steps:
      - name: Deploy update-pet to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_PET_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            export AWS_REGION=${{ secrets.AWS_REGION }}
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            export RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}
            export S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            export DB_PORT=${{ secrets.DB_PORT }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            export DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}

            docker stop update-pet || true
            docker rm update-pet || true

            docker run -d --name update-pet \
              -p 3002:3002 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
              -e AWS_REGION=${{ secrets.AWS_REGION }} \
              -e PET_DB_NAME=${{ secrets.PET_DB_NAME }} \
              -e RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} \
              -e DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }} \
              joeli2104/update-pet:latest

  # Build y Push get-pet-by-id
  build_and_push_get_pet_by_id:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Export environment variables for test
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "PET_DB_NAME=${{ secrets.PET_DB_NAME }}" >> $GITHUB_ENV
          echo "RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}" >> $GITHUB_ENV

      - name: Install dependencies and run tests for get-pet-by-id
        run: |
          cd get-pet-by-id
          npm install
          npm test

      - name: Build and push Docker image for get-pet-by-id
        run: |
          docker build -t joeli2104/get-pet-by-id:latest ./get-pet-by-id
          docker push joeli2104/get-pet-by-id:latest

  deploy_ec2_get_pet_by_id:
    runs-on: ubuntu-latest
    needs: build_and_push_get_pet_by_id
    steps:
      - name: Deploy get-pet-by-id to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_PET_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            export AWS_REGION=${{ secrets.AWS_REGION }}
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            export RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}
            export S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            export DB_PORT=${{ secrets.DB_PORT }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            export DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}

            docker stop get-pet-by-id || true
            docker rm get-pet-by-id || true

            docker run -d --name get-pet-by-id \
              -p 3003:3003 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
              -e AWS_REGION=${{ secrets.AWS_REGION }} \
              -e PET_DB_NAME=${{ secrets.PET_DB_NAME }} \
              -e RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} \
              -e DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }} \
              joeli2104/get-pet-by-id:latest

  # Build y Push get-all-pets
  build_and_push_get_all_pets:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Export environment variables for test
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "PET_DB_NAME=${{ secrets.PET_DB_NAME }}" >> $GITHUB_ENV
          echo "RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}" >> $GITHUB_ENV

      - name: Install dependencies and run tests for get-all-pets
        run: |
          cd get-all-pets
          npm install
          npm test

      - name: Build and push Docker image for get-all-pets
        run: |
          docker build -t joeli2104/get-all-pets:latest ./get-all-pets
          docker push joeli2104/get-all-pets:latest

  deploy_ec2_get_all_pets:
    runs-on: ubuntu-latest
    needs: build_and_push_get_all_pets
    steps:
      - name: Deploy get-all-pets to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_PET_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            export AWS_REGION=${{ secrets.AWS_REGION }}
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            export RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}
            export S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            export DB_PORT=${{ secrets.DB_PORT }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            export DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}

            docker stop get-all-pets || true
            docker rm get-all-pets || true

            docker run -d --name get-all-pets \
              -p 3004:3004 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
              -e AWS_REGION=${{ secrets.AWS_REGION }} \
              -e PET_DB_NAME=${{ secrets.PET_DB_NAME }} \
              -e RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} \
              -e DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }} \
              joeli2104/get-all-pets:latest

  # Build y Push delete-pet
  build_and_push_delete_pet:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Export environment variables for test
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "PET_DB_NAME=${{ secrets.PET_DB_NAME }}" >> $GITHUB_ENV
          echo "RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}" >> $GITHUB_ENV

      - name: Install dependencies and run tests for delete-pet
        run: |
          cd delete-pet
          npm install
          npm test

      - name: Build and push Docker image for delete-pet
        run: |
          docker build -t joeli2104/delete-pet:latest ./delete-pet
          docker push joeli2104/delete-pet:latest

  deploy_ec2_delete_pet:
    runs-on: ubuntu-latest
    needs: build_and_push_delete_pet
    steps:
      - name: Deploy delete-pet to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_PET_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            export AWS_REGION=${{ secrets.AWS_REGION }}
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            export RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }}
            export S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            export DB_PORT=${{ secrets.DB_PORT }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            export DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}

            docker stop delete-pet || true
            docker rm delete-pet || true

            docker run -d --name delete-pet \
              -p 3005:3005 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
              -e AWS_REGION=${{ secrets.AWS_REGION }} \
              -e PET_DB_NAME=${{ secrets.PET_DB_NAME }} \
              -e RESPONSIBLE_DB_NAME=${{ secrets.RESPONSIBLE_DB_NAME }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} \
              -e DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }} \
              joeli2104/delete-pet:latest